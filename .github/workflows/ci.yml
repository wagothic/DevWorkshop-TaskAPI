name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DOTNET_VERSION: '9.0.x'
  SOLUTION_PATH: 'DevWorkshop.TaskAPI.sln'

jobs:
  build-and-test:
    name: ğŸ—ï¸ Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}
      
    - name: ğŸ—ï¸ Build solution
      run: dotnet build ${{ env.SOLUTION_PATH }} --no-restore --configuration Release
      
    - name: ğŸ§ª Run tests
      run: dotnet test ${{ env.SOLUTION_PATH }} --no-build --configuration Release --verbosity normal --collect:"XPlat Code Coverage"
      
    - name: ğŸ“Š Upload coverage reports
      uses: codecov/codecov-action@v3
      if: success()
      with:
        files: '**/coverage.cobertura.xml'
        fail_ci_if_error: false

  code-quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}
      
    - name: ğŸ” Run code analysis
      run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --verbosity normal
      
    - name: ğŸ“‹ Check formatting
      run: dotnet format ${{ env.SOLUTION_PATH }} --verify-no-changes --verbosity diagnostic

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}
      
    - name: ğŸ”’ Run security scan
      run: |
        dotnet list ${{ env.SOLUTION_PATH }} package --vulnerable --include-transitive
        dotnet list ${{ env.SOLUTION_PATH }} package --deprecated

  educational-validation:
    name: ğŸ“ Educational Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Validate TODO comments
      run: |
        echo "ğŸ” Checking for proper TODO format..."
        if grep -r "TODO:" --include="*.cs" . | grep -v "TODO: ESTUDIANTE\|TODO: STUDENT"; then
          echo "âŒ Found TODOs that don't follow educational format"
          echo "âœ… Use: // TODO: ESTUDIANTE - Description"
          exit 1
        else
          echo "âœ… All TODOs follow educational format"
        fi
        
    - name: ğŸ“š Check documentation
      run: |
        echo "ğŸ“š Validating documentation..."
        if [ ! -f "README.md" ]; then
          echo "âŒ README.md is missing"
          exit 1
        fi
        if [ ! -f "CONTRIBUTING.md" ]; then
          echo "âŒ CONTRIBUTING.md is missing"
          exit 1
        fi
        echo "âœ… Documentation files present"
        
    - name: ğŸ—ï¸ Validate Clean Architecture
      run: |
        echo "ğŸ—ï¸ Checking Clean Architecture compliance..."
        
        # Check that Domain has no external dependencies
        if grep -r "using Microsoft\|using System.Data\|using Newtonsoft" DevWorkshop.TaskAPI.Domain/ --include="*.cs" | grep -v "using System;"; then
          echo "âŒ Domain layer has external dependencies"
          exit 1
        fi
        
        # Check that Application only depends on Domain
        if grep -r "using DevWorkshop.TaskAPI.Infrastructure\|using DevWorkshop.TaskAPI.Api" DevWorkshop.TaskAPI.Application/ --include="*.cs"; then
          echo "âŒ Application layer has invalid dependencies"
          exit 1
        fi
        
        echo "âœ… Clean Architecture compliance validated"

  api-documentation:
    name: ğŸ“– API Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}
      
    - name: ğŸ—ï¸ Build API project
      run: dotnet build DevWorkshop.TaskAPI.Api/DevWorkshop.TaskAPI.Api.csproj --configuration Release
      
    - name: ğŸ“– Validate API documentation
      run: |
        echo "ğŸ“– Checking API documentation..."
        
        # Check for XML documentation
        if ! find . -name "*.xml" -path "*/bin/Release/*" | grep -q "DevWorkshop.TaskAPI.Api.xml"; then
          echo "âš ï¸ API XML documentation not found (this is OK for educational template)"
        else
          echo "âœ… API XML documentation found"
        fi
        
        # Check for proper controller documentation
        if ! grep -r "/// <summary>" DevWorkshop.TaskAPI.Api/Controllers/ --include="*.cs"; then
          echo "âŒ Controllers missing XML documentation"
          exit 1
        else
          echo "âœ… Controllers have XML documentation"
        fi

  notify-status:
    name: ğŸ“¢ Notify Status
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality, security-scan, educational-validation, api-documentation]
    if: always()
    
    steps:
    - name: ğŸ“¢ Report Status
      run: |
        echo "ğŸ¯ CI/CD Pipeline Results:"
        echo "ğŸ—ï¸ Build and Test: ${{ needs.build-and-test.result }}"
        echo "ğŸ” Code Quality: ${{ needs.code-quality.result }}"
        echo "ğŸ”’ Security Scan: ${{ needs.security-scan.result }}"
        echo "ğŸ“ Educational Validation: ${{ needs.educational-validation.result }}"
        echo "ğŸ“– API Documentation: ${{ needs.api-documentation.result }}"
        
        if [[ "${{ needs.build-and-test.result }}" == "success" && 
              "${{ needs.code-quality.result }}" == "success" && 
              "${{ needs.security-scan.result }}" == "success" && 
              "${{ needs.educational-validation.result }}" == "success" && 
              "${{ needs.api-documentation.result }}" == "success" ]]; then
          echo "âœ… All checks passed! Ready for educational use ğŸ“"
        else
          echo "âŒ Some checks failed. Please review and fix issues."
        fi
